# --- T2-COPYRIGHT-NOTE-BEGIN ---
# T2 SDE: architecture/powerpc64/package/*/1000-ps3stor-fix-bvec-memcpy.patch
# Copyright (C) 2023 The T2 SDE Project
# 
# This Copyright note is generated by scripts/Create-CopyPatch,
# more information can be found in the files COPYING and README.
# 
# This patch file is dual-licensed. It is available under the license the
# patched project is licensed under, as long as it is an OpenSource license
# as defined at http://www.opensource.org/ (e.g. BSD, X11) or under the terms
# of the GNU General Public License version 2 as used by the T2 SDE.
# --- T2-COPYRIGHT-NOTE-END ---

With 6e0a48552b8c (ps3disk: use memcpy_{from,to}_bvec) in 2021
converting ps3disk to new bvec helpers incrementing the offset was
removed, corrupting consecutive buffers. Restore for uncorrupted
storage data transfers.

Fixed: 6e0a48552b8c (ps3disk: use memcpy_{from,to}_bvec)

Signed-off-by: Ren√© Rebe <rene@exactcode.de>

--- linux/drivers/block/ps3disk.c.vanilla	2023-08-07 17:40:55.200957746 +0200
+++ linux/drivers/block/ps3disk.c	2023-08-07 17:46:39.702964129 +0200
@@ -85,10 +93,14 @@
 	struct bio_vec bvec;
 
 	rq_for_each_segment(bvec, req, iter) {
+		dev_dbg(&dev->sbd.core, "%s:%u: %u sectors from %llu\n",
+			__func__, __LINE__, bio_sectors(iter.bio),
+			iter.bio->bi_iter.bi_sector);
 		if (gather)
 			memcpy_from_bvec(dev->bounce_buf + offset, &bvec);
 		else
 			memcpy_to_bvec(&bvec, dev->bounce_buf + offset);
+		offset += bvec.bv_len;
 	}
 }
 
